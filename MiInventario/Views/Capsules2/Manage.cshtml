@using Microsoft.AspNet.Identity
@{
  ViewBag.Title = "Manage Capsule";
}

<h2>@ViewBag.Title <img id="imgLoading" src='@Url.Content("~/images/loading.gif")' style="vertical-align:baseline;height: 20px;display:none" /></h2>
<div style="margin-bottom: 20px">
  <div class="btn-group">
    <a href="#" id="btnAcciones" data-url="@Url.Action("ManageItems", new { @id = "IdCapsula" })" data-needspawn="false" class="btn btn-primary replacedLink">Manage</a>
    <a href="#" id="btnAccionesDropdown" class="btn btn-primary dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></a>
    <ul class="dropdown-menu">
      <li><a href="#" data-url="@Url.Action("AddItem", new { @id = "IdCapsula" })" data-needspawn="false" class="replacedLink">Add Item</a></li>
      <li><a href="#" data-url="@Url.Action("Load", new { @id = "IdCapsula" })" data-needspawn="false" class="replacedLink">Load</a></li>
      <li><a href="#" data-url="@Url.Action("Unload", new { @id = "IdCapsula" })" data-needspawn="false" class="replacedLink">Unload</a></li>
      <li class="divider"></li>
      <li><a href="#" data-url="@Url.Action("Edit", new { @id = "IdCapsula" })" data-needspawn="false" class="replacedLink">Edit</a></li>
      <li><a href="#" data-url="@Url.Action("Delete", new { @id = "IdCapsula" })" data-needspawn="false" class="replacedLink">Delete</a></li>
      <li class="divider"></li>
      <li><a href="#" data-url="@Url.Action("LogInterests", new { @id = "IdCapsula" })" data-needspawn="true" class="replacedLink">Log Interests</a></li>
      <li><a href="#" data-url="@Url.Action("InterestsDateCapsule", new { grouping = MiInventario.Code.DateGrouping.Day, idCapsula = "IdCapsula" })" data-needspawn="true" class="replacedLink">Interests Capsule by Day</a></li>
      <li><a href="#" data-url="@Url.Action("InterestsDateCapsule", new { grouping = MiInventario.Code.DateGrouping.Week, idCapsula = "IdCapsula" })" data-needspawn="true" class="replacedLink">Interests Capsule by Week</a></li>
      <li><a href="#" data-url="@Url.Action("InterestsDateCapsule", new { grouping = MiInventario.Code.DateGrouping.Month, idCapsula = "IdCapsula" })" data-needspawn="true" class="replacedLink">Interests Capsule by Month</a></li>
      <li><a href="#" data-url="@Url.Action("InterestsTotalCapsule", new { @id = "IdCapsula" })" data-needspawn="true" class="replacedLink">Interests Total</a></li>
      @if (MiInventario.Utils.GetUsernamFromEmail(User.Identity.GetUserName()) == "diegomenta") {
        <li class="divider"></li>
        <li><a href="#" data-url="@Url.Action("SendToUser", new { @id = "IdCapsula", sendToUser = "pceriani@gmail.com" })" data-needspawn="false" class="replacedLink">Send to pceriani</a></li>
      }
      @if (MiInventario.Utils.GetUsernamFromEmail(User.Identity.GetUserName()) == "pceriani") {
        <li class="divider"></li>
        <li><a href="#" data-url="@Url.Action("SendToUser", new { @id = "IdCapsula", sendToUser = "diegomenta@gmail.com" })" data-needspawn="false" class="replacedLink">Send to diegomenta</a></li>
      }
    </ul>
  </div>
</div>

<div class="col-lg-4 col-md-5 col-sm-6 col-xs-12 clearfix">
  <table class="table table-condensed table-striped" id="capsules">
    <colgroup>
      <col class="col-lg-1 col-md-1 col-sm-1 col-xs-1" />
      <col class="col-lg-3 col-md-3 col-sm-3 col-xs-2" />
      <col class="col-lg-6 col-md-6 col-sm-6 col-xs-5" />
      <col class="col-lg-2 col-md-2 col-sm-2 col-xs-1" />
    </colgroup>
    <thead>
      <tr>
        <th></th>
        <th>ID</th>
        <th>Item</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="col-lg-3 col-md-4 col-sm-6 col-xs-12" id="capsuleDetails"></div>

<div class="clearfix"></div>

@section scripts{
  <script src="~/Scripts/InventoryRender.js" type="text/javascript"></script>

  <script type="text/javascript">
    $(document).ready(function () {
      GetCapsules();
    });

    function GetCapsules() {
      $.ajax({
        url: '/Capsules2/GetCapsules',
        method: 'GET',
        dataType: "json",
        cache: false,
        success: function (data) {
          ShowCapsules(data);

          window.capsuleInfo = data;

          Initialize();
        },
        error: function (requestObject, error, errorThrown) {
          alert(errorThrown);
        },
      });
    }

    function ShowCapsules(data) {
      var elemento = $('#capsules tbody');
      elemento.empty();
      /*
      <tr>
      <td class="text-center"><input name="08A6831F" data-spawn="True" type="checkbox" class="selection" /></td>
      <td class="nombreCapsula">08A6831F</td>
      <td class="text-nowrap"><span class="rarezaR4 itemDetailPopUp" detailPopupItem="SHIELD_AXA">AXA Shield</span></td>
      <td class="cantidadTotal">96</td>
      </tr>
      */
      var html = [];
      $.each(data, function (key, capsule) {
        html.push('<tr>');

        html.push('<td class="text-center">');

        html.push('<input name="');
        html.push(capsule.IdCapsula);
        html.push('" data-spawn="');
        html.push(capsule.Spawnable);
        html.push('" type="checkbox" class="selection" />');

        html.push('</td>');

        html.push('<td class="nombreCapsula">');
        html.push(capsule.IdCapsula);
        html.push('</td>');

        html.push('<td class="text-nowrap">');
        if (capsule.Items.length == 1) {
          html.push(RenderItemDescription(capsule.Items[0].CurrentItem));
        }
        else {
          html.push(capsule.ResolvedDescription);
        }
        html.push('</td>');

        html.push('<td>');
        html.push(capsule.Total.toString());
        html.push('</td>');

        html.push('</tr>');
      });

      elemento.append(html.join(''));
    }

    function Initialize() {
      $("input.selection").prop('checked', false);
      $("#btnAcciones,#btnAccionesDropdown").attr('disabled', 'disabled');
      $("a.replacedLink").click(function () {
        var selected = $(".selection:checked");
        if (selected.length == 0) {
          alert("Please select the capsule on which you want to perform the action.");
          return;
        }
        if ($(this).attr("data-needspawn") == "true" && selected.attr("data-spawn") == "False") {
          alert("This action is not valid for this type of capsule.");
          return;
        }
        var irA = $(this).attr("data-url").replace("IdCapsula", selected.attr("name"));
        window.location = irA;
      });
      $("input.selection").click(function () {
        $("input.selection").not(this).prop('checked', false);

        if ($(this).is(':checked')) {
          $("#btnAcciones,#btnAccionesDropdown").removeAttr('disabled');
        }
        else {
          $("#btnAcciones,#btnAccionesDropdown").attr('disabled', 'disabled');
        }
      });
      $('tr').click(function (event) {
        if (event.target.type !== 'checkbox') {
          $(':checkbox', this).trigger('click');
        }
      });
      $(".nombreCapsula").click(function (e) {
        ViewCapsuleDetail($(this).text());
        e.preventDefault();
      });
    }

    function ViewCapsuleDetail(capsuleID) {
      var html = [];
      html.push('<table class="table table-condensed table-striped">');

      html.push('<colgroup>');
      html.push('<col class="col-lg-6 col-md-6 col-sm-6 col-xs-6" />');
      html.push('<col class="col-lg-2 col-md-2 col-sm-2 col-xs-2" />');
      html.push('<col class="col-lg-2 col-md-2 col-sm-2 col-xs-2" />');
      html.push('<col class="col-lg-2 col-md-2 col-sm-2 col-xs-2" />');
      html.push('</colgroup>');

      html.push('<caption>');
      html.push(capsuleID);
      html.push('</caption>');

      html.push('<thead>');
      html.push('<tr>');

      html.push('<th>Item</th>');
      html.push('<th>Qty</th>');

      html.push('</tr>');
      html.push('</thead>');

      html.push('<tbody>');

      var capsule = null;
      for (var i = 0; i < capsuleInfo.length; i++) {
        if (capsuleInfo[i].IdCapsula == capsuleID) {
          capsule = capsuleInfo[i];
          break;
        }
      }

      if (capsule.Items != null) {
        $.each(capsule.Items, function (key, item) {
          html.push('<tr>');

          html.push('<td class="nombre">');
          html.push(RenderItemDescription(item.CurrentItem));
          html.push('</td>');

          html.push('<td class="cantidadItem">');
          html.push(item.Quantity.toString());
          html.push('</td>');

          html.push('</tr>');
        });
      }

      html.push('</tbody>');

      html.push('</table>');

      $('#capsuleDetails').html(html.join(''));

    }
  </script>
}
